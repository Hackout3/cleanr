---
title: "Rules for field/column combinations"
author: "Edwin van Leeuwen, Marc Baguelin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r,include=F}
library(pander)
```

The package `cleanr` supports defining a set of rules that fields/columns need to conform to, e.g. the values in one column should always be higher than in another. The rules are defined can be read from a yaml file, or passed as a list. There are two types of rules supported 1) a required relation between fields (e.g. one field need to always be higher than the other and 2) accepted/valid and invalid combinations of values (e.g. the outcome of a disease needs to be death if a time of death is set).

Below follow some examples. All examples use an simulated set of epidemiological data (`epi.sim`)
```{r,echo=F}
library(cleanr)
data(epi.sim)
pander(head(epi.sim))
```

## Relation between columns

Relation rules are linking two columns with a rule that should be respected for all the pairs of values. To test if the rule is respected in a given dataset, the `rule_validation` function can be used with the rules inputed from a yaml file.

For example by using the rule.yaml file that contains the following rule:
```
- fields:
    - date.of.onset
    - date.of.hospitalisation
  relation: lte
```
we require that date.of.onset should always be lesser than or equal to date.of.hospitalisation.
```{r,eval=F}
rule_validation(epi.sim, rules.file="rule.yaml")
```
which passes for our data set. In contrast, if we require the date.of.onset to be strictly lesser than, by replacing `lte` with `lt` it will throw a warning and return `FALSE`:
```{r,echo=F}
  data(epi.sim)
  rule_validation(epi.sim, rules=list(list(
    "fields"=c("date.of.onset", "date.of.hospitalisation"), "relation"="lt" ) ) )
```

## (In)valid combinations of values

[in progress]

The combination set of rules define combinations of values between columns which are valid or invalid.  

Combinations to be supported:

- If male then not vagina
- If date.of.death then outcome needs to be death (this is a dependent pair I guess)
- Define all valid pairs (no other pairing is allowed)

For example by using the rule.yaml file that contains the following rule:
```
- fields:
    - gender
    - generation
  valid: [[f,0],[m,1]]
```

```{r,echo=F}
  data(epi.sim)
  rule_validation(epi.sim, rules=list(list(
    "fields"=c("date.of.onset", "date.of.hospitalisation"), "relation"="lt" ) ) )
```

## Conditional values in dataset

[in progress]

Some values are imposed conditional of others in the dataset. For example if a patient is given a date of death, their status need to be "dead". A patient whose status in the dataset is "alive" while having a date of death should be flagged up for correction.

For example by using the rule.yaml file that contains the following rule:
```
- fields:
    - date.of.death
    - status
  conditional:[]
```

```{r,echo=F}
  data(epi.sim)
  rule_validation(epi.sim, rules=list(list(
    "fields"=c("date.of.onset", "date.of.hospitalisation"), "relation"="lt" ) ) )
```
